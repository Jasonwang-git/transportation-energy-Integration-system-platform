<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤é€šèƒ½æºèåˆç³»ç»Ÿå¹³å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš„</text></svg>">
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: 'ea33d905135a473d65bb441662158dcf'
        };
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=c4ac4b0c74ddd085b34f2bb34fac5864&plugin=AMap.PlaceSearch"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-panel {
            width: 400px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .panel-header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .panel-header p {
            font-size: 14px;
            opacity: 0.8;
        }

        .search-section {
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #45a049;
        }

        .coords-section {
            margin-bottom: 25px;
        }

        .coords-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .coord-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
        }

        .coord-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .data-source-section {
            margin-bottom: 25px;
        }


        .time-section {
            margin-bottom: 25px;
        }

        .time-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 12px;
            margin-bottom: 10px;
        }


        .function-modules {
            margin-bottom: 20px;
        }

        .module {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .module-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s;
        }

        .module-header:hover {
            background: rgba(255,255,255,0.1);
        }

        .module-title {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
        }

        .module-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .module.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .module-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.1);
        }

        .module.expanded .module-content {
            max-height: 300px;
        }

        .module-options {
            padding: 15px;
        }

        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-label {
            font-size: 12px;
        }

        .option-btn {
            padding: 4px 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: background 0.3s;
        }

        .option-btn:hover {
            background: #1976D2;
        }

        .right-panel {
            flex: 1;
            position: relative;
            background: #e0e0e0;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
        }



        #search-result-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }
        
        #search-result-panel .amap-poi-panel {
            border: none !important;
            box-shadow: none !important;
        }
        
        #search-result-panel .amap-poi-panel .amap-poi-panel-header {
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            font-weight: bold;
        }
        
        #search-result-panel .amap-poi-panel .amap-poi-panel-content {
            padding: 0;
        }
        
        #search-result-panel .amap-poi-panel .amap-poi-panel-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        #search-result-panel .amap-poi-panel .amap-poi-panel-item:hover {
            background: #f9f9f9;
        }
        
        .search-panel-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .search-panel-close:hover {
            color: #333;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="panel-header">
                <h1>äº¤é€šä¸èƒ½æºèåˆç³»ç»Ÿå¹³å°</h1>
                <p>é“è·¯è‡ªæ´½èƒ½æºç³»ç»Ÿè§„åˆ’è®¾è®¡</p>
            </div>

            <div class="search-section">
                <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">çº¿è·¯æœç´¢</div>
                <div class="coords-row">
                    <div style="flex: 1; margin-right: 5px;">
                        <input type="text" class="coord-input" placeholder="èµ·å§‹ç«™">
                    </div>
                    <div style="flex: 1; margin-left: 5px;">
                        <input type="text" class="coord-input" placeholder="ç»ˆåˆ°ç«™">
                    </div>
                </div>
                <button class="search-btn">ğŸš„ æŸ¥è¯¢çº¿è·¯</button>
            </div>

            <div class="search-section">
                <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">ç«™ç‚¹æœç´¢</div>
                <input type="text" id="stationSearchInput" class="search-input" placeholder="è¯·è¾“å…¥é«˜é“ç«™æˆ–çº¿è·¯è¿›è¡Œæœç´¢">
                <button class="search-btn" onclick="searchStationAndUpdateCoords()">ğŸ” ç«™ç‚¹æœç´¢</button>
            </div>

            <div class="coords-section">
                <div class="coords-row">
                    <div style="flex: 1; margin-right: 5px;">
                        <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">ç»åº¦</div>
                        <input type="text" id="lngInput" class="coord-input" placeholder="ç»åº¦" value="121.6845">
                    </div>
                    <div style="flex: 1; margin-left: 5px;">
                        <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">çº¬åº¦</div>
                        <input type="text" id="latInput" class="coord-input" placeholder="çº¬åº¦" value="31.2304">
                    </div>
                </div>
            </div>

            <div class="data-source-section">
                <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">æ•°æ®æº</div>
                <select class="time-input">
                    <option>NASAæ°”è±¡æ•°æ®: å…¨çƒæ°”è±¡è§‚æµ‹</option>
                    <option>NASAå«æ˜Ÿæ•°æ®: åœ°çƒè§‚æµ‹å«æ˜Ÿ</option>
                    <option>NASAæ°”å€™æ•°æ®: é•¿æœŸæ°”å€™åˆ†æ</option>
                    <option>NASAå¤ªé˜³æ•°æ®: å¤ªé˜³è¾å°„ç›‘æµ‹</option>
                </select>
            </div>

            <div class="time-section">
                <div style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">èµ·æ­¢æ—¶é—´</div>
                <input type="datetime-local" class="time-input" value="2022-01-01T00:00">
                <input type="datetime-local" class="time-input" value="2022-01-31T23:59">
            </div>

            <div class="function-modules">
                <div class="module" data-module="load-forecast">
                    <div class="module-header">
                        <div class="module-title">
                            <div class="module-icon">ğŸ“Š</div>
                            è´Ÿè·é¢„æµ‹
                        </div>
                        <div class="expand-icon">â–¼</div>
                    </div>
                    <div class="module-content">
                        <div class="module-options">
                            <div class="option-item">
                                <span class="option-label">å…‰ä¼å‘ç”µé¢„æµ‹</span>
                                <button class="option-btn">é¢„æµ‹</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">é£åŠ›å‘ç”µé¢„æµ‹</span>
                                <button class="option-btn">é¢„æµ‹</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">æ°´åŠ›å‘ç”µé¢„æµ‹</span>
                                <button class="option-btn">é¢„æµ‹</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="module" data-module="potential-assessment">
                    <div class="module-header">
                        <div class="module-title">
                            <div class="module-icon">ğŸ“ˆ</div>
                            æ½œåŠ›è¯„ä¼°
                        </div>
                        <div class="expand-icon">â–¼</div>
                    </div>
                    <div class="module-content">
                        <div class="module-options">
                            <div class="option-item">
                                <span class="option-label">è´Ÿè·æ•°æ®çš„è¾“å…¥</span>
                                <button class="option-btn">è¾“å…¥</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">é¢„æµ‹æ¨¡å‹çš„é€‰æ‹©</span>
                                <button class="option-btn">é€‰æ‹©</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">é•¿æœŸè´Ÿè·é¢„æµ‹</span>
                                <button class="option-btn">é¢„æµ‹</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="module" data-module="planning-design">
                    <div class="module-header">
                        <div class="module-title">
                            <div class="module-icon">ğŸ—ï¸</div>
                            è§„åˆ’è®¾è®¡
                        </div>
                        <div class="expand-icon">â–¼</div>
                    </div>
                    <div class="module-content">
                        <div class="module-options">
                            <div class="option-item">
                                <span class="option-label">æ¶æ„è®¾è®¡</span>
                                <button class="option-btn">è®¾è®¡</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">è®¾å¤‡é€‰å‹é…ç½®</span>
                                <button class="option-btn">é…ç½®</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">å®¹é‡é…ç½®</span>
                                <button class="option-btn">é…ç½®</button>
                            </div>
                            <div class="option-item">
                                <span class="option-label">è§„åˆ’æ–¹æ¡ˆè¯„ä¼°</span>
                                <button class="option-btn">è¯„ä¼°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div id="mapContainer"></div>
            
            <div id="search-result-panel" style="display: none;"></div>

        </div>
    </div>

    <script>
        document.querySelectorAll('.module').forEach(module => {
            const header = module.querySelector('.module-header');
            header.addEventListener('click', () => {
                module.classList.toggle('expanded');
            });
        });

        document.querySelectorAll('.search-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                if (index === 0) {
                    const startStation = document.querySelectorAll('.coord-input')[0].value;
                    const endStation = document.querySelectorAll('.coord-input')[1].value;
                    if (startStation.trim() && endStation.trim()) {
                        searchRoute(startStation, endStation);
                    } else {
                        alert('è¯·è¾“å…¥èµ·å§‹ç«™å’Œç»ˆåˆ°ç«™');
                    }
                } else {
            const searchValue = document.querySelector('.search-input').value;
            if (searchValue.trim()) {
                        searchStation(searchValue);
                    }
            }
            });
        });

        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const optionLabel = e.target.parentElement.querySelector('.option-label').textContent;
                const module = e.target.closest('.module').dataset.module;
                
                try {
                    await handleModuleAction(module, optionLabel);
                } catch (error) {
                    console.error('æ‰§è¡ŒåŠŸèƒ½å¤±è´¥:', error);
                    alert(`æ‰§è¡Œå¤±è´¥: ${error.message}`);
                }
            });
        });

        async function handleModuleAction(module, action) {
            const startDate = document.querySelector('input[type="datetime-local"]').value;
            const endDate = document.querySelectorAll('input[type="datetime-local"]')[1].value;
            
            switch(module) {
                case 'load-forecast':
                    await handleLoadForecast(action, startDate, endDate);
                    break;
                case 'potential-assessment':
                    await handlePotentialAssessment(action, startDate, endDate);
                    break;
                case 'planning-design':
                    await handlePlanningDesign(action, startDate, endDate);
                    break;
                default:
                    alert(`æ­£åœ¨æ‰§è¡Œ: ${action}`);
            }
        }

        async function handleLoadForecast(action, startDate, endDate) {
            if (action === 'å…‰ä¼å‘ç”µé¢„æµ‹') {
                await showPVForecastModal(startDate, endDate);
            } else {
                alert(`è´Ÿè·é¢„æµ‹åŠŸèƒ½å¼€å‘ä¸­\næ“ä½œ: ${action}\næ—¶é—´èŒƒå›´: ${startDate} åˆ° ${endDate}\n\nç­‰å¾…è®¡ç®—ä»£ç å¯¼å…¥...`);
            }
        }

        async function showPVForecastModal(startDate, endDate) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'pvForecastModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">ğŸŒ å…‰ä¼å‘ç”µé¢„æµ‹</h2>
                        <button onclick="closePVForecastModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">è£…æœºå®¹é‡ (kW)</label>
                                <input type="number" id="installedCapacity" value="1000" min="1" max="10000" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…‰ä¼æ¿æ•ˆç‡</label>
                                <input type="number" id="panelEfficiency" value="0.20" min="0.1" max="0.3" step="0.01"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">é€†å˜å™¨æ•ˆç‡</label>
                                <input type="number" id="inverterEfficiency" value="0.95" min="0.8" max="1.0" step="0.01"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¹´è¡°å‡ç‡</label>
                                <input type="number" id="degradationRate" value="0.005" min="0" max="0.02" step="0.001"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button onclick="calculatePVForecast()" 
                                    style="flex: 1; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                ğŸ”‹ è®¡ç®—å‘ç”µé¢„æµ‹
                            </button>
                            <button onclick="calculateYearlyPVForecast()" 
                                    style="flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                ğŸ“… å¤šå¹´é¢„æµ‹
                            </button>
                        </div>
                    </div>
                    
                    <div id="pvForecastResults" style="display: none;">
                        <h3 style="color: #333; margin-bottom: 15px;">é¢„æµ‹ç»“æœ</h3>
                        <div id="pvResultsContent"></div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <div style="font-size: 12px; color: #666;">
                            <strong>è¯´æ˜:</strong><br>
                            â€¢ åŸºäºåœ°è¡¨è¾å°„æ•°æ®å’Œæ¸©åº¦è¿›è¡Œå‘ç”µé‡è®¡ç®—<br>
                            â€¢ è€ƒè™‘è®¾å¤‡æ•ˆç‡ã€æ¸©åº¦ç³»æ•°å’Œè¡°å‡å› ç´ <br>
                            â€¢ éœ€è¦å…ˆåœ¨ç«™ç‚¹æœç´¢æ¡†ä¸­è¾“å…¥ç«™ç‚¹åç§°<br>
                            â€¢ æ”¯æŒè‡ªå®šä¹‰æ—¶é—´åŒºé—´æŸ¥è¯¢
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closePVForecastModal() {
            const modal = document.getElementById('pvForecastModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        async function calculatePVForecast() {
            const startDate = document.querySelector('input[type="datetime-local"]').value;
            const endDate = document.querySelectorAll('input[type="datetime-local"]')[1].value;
            const stationSearchInput = document.getElementById('stationSearchInput').value.trim();
            
            if (!stationSearchInput) {
                alert('è¯·å…ˆè¾“å…¥ç«™ç‚¹åç§°');
                return;
            }
            
            const installedCapacity = parseFloat(document.getElementById('installedCapacity').value);
            const panelEfficiency = parseFloat(document.getElementById('panelEfficiency').value);
            const inverterEfficiency = parseFloat(document.getElementById('inverterEfficiency').value);
            const degradationRate = parseFloat(document.getElementById('degradationRate').value);
            
            try {
                // æ ¹æ®ç«™ç‚¹åç§°æœç´¢ç«™ç‚¹
                const searchResponse = await fetch(`/api/stations/search?keyword=${encodeURIComponent(stationSearchInput)}&limit=1`);
                const searchData = await searchResponse.json();
                
                if (!searchData.stations || searchData.stations.length === 0) {
                    alert(`æœªæ‰¾åˆ°ç«™ç‚¹"${stationSearchInput}"ï¼Œè¯·æ£€æŸ¥ç«™ç‚¹åç§°æ˜¯å¦æ­£ç¡®`);
                    return;
                }
                
                const stationId = searchData.stations[0].id;
                
                // è®¡ç®—å…‰ä¼å‘ç”µé¢„æµ‹
                const response = await fetch('/api/pv-forecast/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        station_id: stationId,
                        start_date: startDate,
                        end_date: endDate,
                        installed_capacity_kw: installedCapacity,
                        panel_efficiency: panelEfficiency,
                        inverter_efficiency: inverterEfficiency,
                        degradation_rate: degradationRate
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayPVForecastResults(result);
                } else {
                    alert(`è®¡ç®—å¤±è´¥: ${result.detail}`);
                }
                
            } catch (error) {
                console.error('è®¡ç®—å…‰ä¼å‘ç”µé¢„æµ‹å¤±è´¥:', error);
                alert('è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        async function calculateYearlyPVForecast() {
            const stationSearchInput = document.getElementById('stationSearchInput').value.trim();
            
            if (!stationSearchInput) {
                alert('è¯·å…ˆè¾“å…¥ç«™ç‚¹åç§°');
                return;
            }
            
            const installedCapacity = parseFloat(document.getElementById('installedCapacity').value);
            const degradationRate = parseFloat(document.getElementById('degradationRate').value);
            
            try {
                // æ ¹æ®ç«™ç‚¹åç§°æœç´¢ç«™ç‚¹
                const searchResponse = await fetch(`/api/stations/search?keyword=${encodeURIComponent(stationSearchInput)}&limit=1`);
                const searchData = await searchResponse.json();
                
                if (!searchData.stations || searchData.stations.length === 0) {
                    alert(`æœªæ‰¾åˆ°ç«™ç‚¹"${stationSearchInput}"ï¼Œè¯·æ£€æŸ¥ç«™ç‚¹åç§°æ˜¯å¦æ­£ç¡®`);
                    return;
                }
                
                const stationId = searchData.stations[0].id;
                
                // è®¡ç®—å¤šå¹´å…‰ä¼å‘ç”µé¢„æµ‹
                const response = await fetch(`/api/pv-forecast/yearly/${stationId}?years=5&installed_capacity_kw=${installedCapacity}&degradation_rate=${degradationRate}`);
                const result = await response.json();
                
                if (response.ok) {
                    displayYearlyPVForecastResults(result);
                } else {
                    alert(`è®¡ç®—å¤±è´¥: ${result.detail}`);
                }
                
            } catch (error) {
                console.error('è®¡ç®—å¤šå¹´å…‰ä¼å‘ç”µé¢„æµ‹å¤±è´¥:', error);
                alert('è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        function displayPVForecastResults(result) {
            const resultsDiv = document.getElementById('pvForecastResults');
            const contentDiv = document.getElementById('pvResultsContent');
            
            contentDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“Š é¢„æµ‹æ‘˜è¦</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>æ€»å‘ç”µé‡:</strong> ${result.total_generation_kwh.toLocaleString()} kWh</div>
                        <div><strong>å¹³å‡æ—¥å‘ç”µé‡:</strong> ${result.average_daily_generation_kwh.toLocaleString()} kWh</div>
                        <div><strong>å®¹é‡å› å­:</strong> ${(result.capacity_factor * 100).toFixed(2)}%</div>
                        <div><strong>æ•°æ®ç‚¹æ•°:</strong> ${result.data_points}</div>
                    </div>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f5f5f5; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ—¶é—´</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¤ªé˜³è¾å°„ (W/mÂ²)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ¸©åº¦ (Â°C)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å‘ç”µé‡ (kWh)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.forecast_results.slice(0, 50).map(item => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${new Date(item.timestamp).toLocaleString()}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.solar_radiation_wm2.toFixed(2)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.temperature_c.toFixed(1)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.hourly_generation_kwh.toFixed(4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${result.forecast_results.length > 50 ? `<div style="padding: 10px; text-align: center; color: #666;">æ˜¾ç¤ºå‰50æ¡è®°å½•ï¼Œå…±${result.forecast_results.length}æ¡</div>` : ''}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function displayYearlyPVForecastResults(result) {
            const resultsDiv = document.getElementById('pvForecastResults');
            const contentDiv = document.getElementById('pvResultsContent');
            
            contentDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“… å¤šå¹´é¢„æµ‹æ‘˜è¦</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>ç«™ç‚¹:</strong> ${result.station_name} (${result.province})</div>
                        <div><strong>è£…æœºå®¹é‡:</strong> ${result.installed_capacity_kw.toLocaleString()} kW</div>
                        <div><strong>åŸºå‡†å¹´å‘ç”µé‡:</strong> ${result.base_year_generation_kwh.toLocaleString()} kWh</div>
                        <div><strong>å¹´è¡°å‡ç‡:</strong> ${(result.degradation_rate * 100).toFixed(2)}%</div>
                        <div><strong>æ•°æ®å¹´ä»½:</strong> ${result.data_year || 'æœªçŸ¥'}</div>
                        <div><strong>æ•°æ®ç‚¹æ•°:</strong> ${result.data_points || 0}</div>
                    </div>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f5f5f5; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¹´ä»½</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¹´å‘ç”µé‡ (kWh)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¹³å‡æ—¥å‘ç”µé‡ (kWh)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å®¹é‡å› å­</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è¡°å‡å› å­</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.yearly_forecasts.map(item => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.year}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.total_generation_kwh.toLocaleString()}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${item.average_daily_generation_kwh.toLocaleString()}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${(item.capacity_factor * 100).toFixed(2)}%</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${(item.degradation_factor * 100).toFixed(2)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        async function handlePotentialAssessment(action, startDate, endDate) {
            alert(`æ½œåŠ›è¯„ä¼°åŠŸèƒ½å¼€å‘ä¸­\næ“ä½œ: ${action}\næ—¶é—´èŒƒå›´: ${startDate} åˆ° ${endDate}\n\nç­‰å¾…è®¡ç®—ä»£ç å¯¼å…¥...`);
        }

        async function handlePlanningDesign(action, startDate, endDate) {
            alert(`è§„åˆ’è®¾è®¡åŠŸèƒ½å¼€å‘ä¸­\næ“ä½œ: ${action}\næ—¶é—´èŒƒå›´: ${startDate} åˆ° ${endDate}\n\nç­‰å¾…è®¡ç®—ä»£ç å¯¼å…¥...`);
        }

        let map;
        let markers = [];
        let routes = [];
        let scale, toolBar, controlBar, overView;

        function initMap() {
            map = new AMap.Map('mapContainer', {
                zoom: 11,
                center: [121.6845, 31.2304],
                mapStyle: 'amap://styles/normal',
                viewMode: '2D',
                pitch: 0,
                showLabel: true
            });

            initMapControls();
        }

        function initMapControls() {
            AMap.plugin(['AMap.Scale', 'AMap.ToolBar', 'AMap.ControlBar', 'AMap.HawkEye', 'AMap.MapType'], function() {
                scale = new AMap.Scale({ visible: true });
                
                toolBar = new AMap.ToolBar({
                    visible: true,
                    position: {
                        top: '110px',
                        right: '40px'
                    }
                });
                
                controlBar = new AMap.ControlBar({
                    visible: true,
                    position: {
                        top: '10px',
                        right: '10px'
                    }
                });
                
                overView = new AMap.HawkEye({ visible: true });

                const mapType = new AMap.MapType({
                    position: { top: '200px', right: '40px' }
                });

                map.addControl(scale);
                map.addControl(toolBar);
                map.addControl(controlBar);
                map.addControl(overView);
                map.addControl(mapType);
            });
        }

        function searchStation(stationName) {
            if (!stationName || stationName.trim() === '') {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            clearSearchResults();
            
            const panel = document.getElementById('search-result-panel');
            panel.style.display = 'block';
            panel.innerHTML = `
                <div style="padding: 15px; text-align: center; position: relative;">
                    <button class="search-panel-close" onclick="closeSearchPanel()">Ã—</button>
                    <div>æ­£åœ¨æœç´¢ "${stationName}"...</div>
                </div>
            `;
            
            AMap.plugin(["AMap.PlaceSearch"], function () {
                const placeSearch = new AMap.PlaceSearch({
                    pageSize: 10,
                    pageIndex: 1,
                    city: 'å…¨å›½',
                    citylimit: false,
                    map: map,
                    panel: 'search-result-panel',
                    autoFitView: true
                });

                placeSearch.search(stationName);
            });
            
            setTimeout(function() {
                if (panel.innerHTML.includes('æ­£åœ¨æœç´¢')) {
                    panel.innerHTML = `
                        <div style="padding: 15px; text-align: center; position: relative;">
                            <button class="search-panel-close" onclick="closeSearchPanel()">Ã—</button>
                            <div>æœç´¢è¶…æ—¶ï¼Œè¯·é‡è¯•</div>
                        </div>
                    `;
                }
            }, 10000);
        }
        
        function closeSearchPanel() {
            const panel = document.getElementById('search-result-panel');
            panel.style.display = 'none';
            clearSearchResults();
        }

        function searchRoute(startStation, endStation) {
            clearSearchResults();
            clearRoutes();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 9999;">
                    <div style="text-align: center;">
                        <div style="margin-bottom: 10px;">ğŸ”</div>
                        <div>æ­£åœ¨æŸ¥è¯¢çº¿è·¯...</div>
                        <div style="font-size: 12px; margin-top: 5px;">${startStation} â†’ ${endStation}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            AMap.plugin(['AMap.Driving', 'AMap.PlaceSearch'], function() {
                const placeSearch = new AMap.PlaceSearch({
                    city: 'å…¨å›½',
                    pageSize: 5,
                    citylimit: false
                });
                
                placeSearch.search(startStation, function(status1, result1) {
                    if (status1 === 'complete' && result1.poiList.pois.length > 0) {
                        const startPoi = result1.poiList.pois[0];
                        const startPosition = [startPoi.location.lng, startPoi.location.lat];
                        
                        placeSearch.search(endStation, function(status2, result2) {
                            document.body.removeChild(loadingDiv);
                            
                            if (status2 === 'complete' && result2.poiList.pois.length > 0) {
                                const endPoi = result2.poiList.pois[0];
                                const endPosition = [endPoi.location.lng, endPoi.location.lat];
                                
                                addStationMarker(startPosition, startPoi.name, 'start');
                                addStationMarker(endPosition, endPoi.name, 'end');
                                
                                const driving = new AMap.Driving({
                                    map: map,
                                    showTraffic: false,
                                    hideMarkers: true,
                                    autoFitView: true
                                });
                                
                                driving.search(startPosition, endPosition, function(status, result) {
                                    if (status === 'complete' && result.routes.length > 0) {
                                        const route = result.routes[0];
                                        
                                        showRouteInfo(startPoi.name, endPoi.name, route);
                                        
                                        map.setFitView();
                                    } else {
                                        alert('æœªæ‰¾åˆ°å¯é€šè¡Œçš„çº¿è·¯');
                                    }
                                });
                            } else {
                                alert(`æœªæ‰¾åˆ°ç»ˆç‚¹ç«™: ${endStation}`);
                            }
                        });
                    } else {
                        document.body.removeChild(loadingDiv);
                        alert(`æœªæ‰¾åˆ°èµ·å§‹ç«™: ${startStation}`);
                    }
                });
            });
        }
        
        function addStationMarker(position, name, type) {
            const color = type === 'start' ? '#4CAF50' : '#FF6B6B';
            const icon = type === 'start' ? 'ğŸš‰' : 'ğŸ';
            
            const marker = new AMap.Marker({
                position: position,
                title: name,
                icon: new AMap.Icon({
                    size: new AMap.Size(32, 32),
                    image: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="32" height="32" viewBox="0 0 32 32">
                            <circle cx="16" cy="16" r="12" fill="${color}" stroke="#fff" stroke-width="2"/>
                            <text x="16" y="20" text-anchor="middle" fill="white" font-size="12">${icon}</text>
                        </svg>
                    `)
                })
            });
            
            map.add(marker);
            markers.push(marker);
            
            const infoWindow = new AMap.InfoWindow({
                content: `<div style="padding: 10px;">
                    <h3 style="margin: 0 0 5px 0; color: ${color};">${name}</h3>
                    <p style="margin: 0; font-size: 12px;">${type === 'start' ? 'èµ·å§‹ç«™' : 'ç»ˆç‚¹ç«™'}</p>
                </div>`
            });
            infoWindow.open(map, position);
        }
        
        function showRouteInfo(startName, endName, route) {
            const infoWindow = new AMap.InfoWindow({
                content: `<div style="padding: 15px; min-width: 250px;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">ğŸš„ çº¿è·¯æŸ¥è¯¢ç»“æœ</h3>
                    <div style="margin-bottom: 8px;">
                        <strong>èµ·ç‚¹:</strong> ${startName}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ç»ˆç‚¹:</strong> ${endName}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>æ€»è·ç¦»:</strong> ${(route.distance / 1000).toFixed(2)} å…¬é‡Œ
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>é¢„è®¡æ—¶é—´:</strong> ${Math.round(route.time / 60)} åˆ†é’Ÿ
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>è·¯å¾„è§„åˆ’:</strong> ${route.steps.length} ä¸ªè·¯æ®µ
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        ğŸ’¡ ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                    </div>
                </div>`
            });
            
            infoWindow.open(map, route.path[0]);
        }

        function searchStationAndUpdateCoords() {
            const stationSearchInput = document.getElementById('stationSearchInput');
            const stationName = stationSearchInput.value.trim();
            
            if (!stationName) {
                alert('è¯·è¾“å…¥ç«™ç‚¹åç§°');
                return;
            }
            
            clearSearchResults();
            
            const panel = document.getElementById('search-result-panel');
            panel.style.display = 'block';
            panel.innerHTML = `
                <div style="padding: 15px; text-align: center; position: relative;">
                    <button class="search-panel-close" onclick="closeSearchPanel()">Ã—</button>
                    <div>æ­£åœ¨æœç´¢ "${stationName}"...</div>
                </div>
            `;
            
            AMap.plugin(["AMap.PlaceSearch"], function () {
                const placeSearch = new AMap.PlaceSearch({
                    pageSize: 10,
                    pageIndex: 1,
                    city: 'å…¨å›½',
                    citylimit: false,
                    map: map,
                    panel: 'search-result-panel',
                    autoFitView: true
                });

                placeSearch.search(stationName, function(status, result) {
                    if (status === 'complete' && result.poiList.pois.length > 0) {
                        const poi = result.poiList.pois[0];
                        const position = [poi.location.lng, poi.location.lat];
                        
                        document.getElementById('lngInput').value = poi.location.lng.toFixed(6);
                        document.getElementById('latInput').value = poi.location.lat.toFixed(6);
                        
                        const marker = new AMap.Marker({
                            position: position,
                            title: poi.name,
                            icon: new AMap.Icon({
                                size: new AMap.Size(32, 32),
                                image: 'data:image/svg+xml;base64,' + btoa(`
                                    <svg width="32" height="32" viewBox="0 0 32 32">
                                        <circle cx="16" cy="16" r="12" fill="#FF6B6B" stroke="#fff" stroke-width="2"/>
                                        <text x="16" y="20" text-anchor="middle" fill="white" font-size="12">ğŸš„</text>
                                    </svg>
                                `)
                            })
                        });
                        
                        map.add(marker);
                        markers.push(marker);
                        
                        const infoWindow = new AMap.InfoWindow({
                            content: `
                                <div style="padding: 15px; min-width: 250px;">
                                    <h3 style="margin: 0 0 10px 0; color: #333;">ğŸš„ ${poi.name}</h3>
                                    <div style="margin-bottom: 8px;">
                                        <strong>ç»åº¦:</strong> ${poi.location.lng.toFixed(6)}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>çº¬åº¦:</strong> ${poi.location.lat.toFixed(6)}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <strong>åœ°å€:</strong> ${poi.address || 'æœªçŸ¥åœ°å€'}
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                                        ğŸ’¡ åæ ‡å·²è‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†
                                    </div>
                                </div>
                            `
                        });
                        
                        infoWindow.open(map, position);
                        
                        map.setCenter(position);
                        map.setZoom(15);
                        
                    } else {
                        alert('æœªæ‰¾åˆ°è¯¥ç«™ç‚¹ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦æ­£ç¡®');
                        panel.style.display = 'none';
                    }
                });
            });
        }

        function clearSearchResults() {
            markers.forEach(marker => {
                map.remove(marker);
            });
            markers = [];
        }

        function clearRoutes() {
            routes.forEach(route => {
                map.remove(route);
            });
            routes = [];
        }



        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
